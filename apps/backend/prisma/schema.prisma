generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  googleId    String?  @unique
  fingerprint String?  @unique
  name        String?
  picture     String?
  createdAt   DateTime @default(now())
  lastLoginAt DateTime @updatedAt
  wallets     Wallet[]

  @@index([googleId])
  @@index([fingerprint])
}

model Wallet {
  id               String          @id @default(cuid())
  userId           String
  salt             String
  encryptedSeed    String
  encryptedEntropy String
  createdAt        DateTime        @default(now())
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  addresses        WalletAddress[]

  @@index([userId])
}

model WalletAddress {
  id        String   @id @default(cuid())
  walletId  String
  chain     String
  address   String
  createdAt DateTime @default(now())
  wallet    Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, chain])
  @@index([walletId])
  @@index([address])
}

model WalletSeed {
  id         String   @id @default(cuid())
  userId     String   @unique
  ciphertext String
  iv         String
  authTag    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

// Stores wallet history for authenticated users (Google login)
// Allows users to switch between previously created wallets
model WalletHistory {
  id         String   @id @default(cuid())
  userId     String   // Google user ID
  label      String?  // User-friendly name like "Wallet 1", "Savings", etc.
  ciphertext String   // Encrypted seed phrase
  iv         String
  authTag    String
  isActive   Boolean  @default(false) // Only one wallet should be active per user
  createdAt  DateTime @default(now())
  
  @@index([userId])
  @@index([userId, isActive])
  @@map("wallet_history")
}

model WalletCache {
  id             String   @id @default(cuid())
  fingerprint    String   @unique
  cachedBalances Json
  lastUpdated    DateTime @default(now()) @updatedAt
  createdAt      DateTime @default(now())

  @@index([fingerprint])
  @@map("wallet_cache")
}

model WalletAddressCache {
  id          String   @id @default(cuid())
  fingerprint String
  chain       String
  address     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([fingerprint, chain])
  @@index([fingerprint])
  @@index([chain])
  @@map("wallet_address_cache")
}
